// Copyright (c) 2016-2022 Association of Universities for Research in Astronomy, Inc. (AURA)
// For license information see LICENSE or https://opensource.org/licenses/BSD-3-Clause

package seqexec.server.tcs

import cats.syntax.all._
import edu.gemini.seqexec.server.tcs.BinaryOnOff
import edu.gemini.seqexec.server.tcs.BinaryYesNo
import seqexec.model.M1GuideConfig
import seqexec.model.M2GuideConfig
import seqexec.model.enum.ComaOption
import seqexec.model.enum.M1Source
import seqexec.model.enum.MountGuideOption
import seqexec.model.enum.TipTiltSource
import seqexec.server.EpicsCodex.DecodeEpicsValue
import seqexec.server.tcs.TcsController.FollowOption.FollowOff
import seqexec.server.tcs.TcsController.FollowOption.FollowOn
import seqexec.server.tcs.TcsController._

trait TcsConfigDecoders {
  // Code to retrieve the current configuration from TCS. Include a lot of decoders
  implicit val decodeMountGuideOption: DecodeEpicsValue[Int, MountGuideOption] =
    DecodeEpicsValue((d: Int) =>
      if (d === 0) MountGuideOption.MountGuideOff else MountGuideOption.MountGuideOn
    )

  implicit val decodeM1GuideSource: DecodeEpicsValue[String, M1Source] =
    DecodeEpicsValue((s: String) =>
      s.trim match {
        case "PWFS1" => M1Source.PWFS1
        case "PWFS2" => M1Source.PWFS2
        case "OIWFS" => M1Source.OIWFS
        case "GAOS"  => M1Source.GAOS
        case _       => M1Source.PWFS1
      }
    )

  def decodeM1Guide(r: BinaryOnOff, s: M1Source): M1GuideConfig =
    if (r === BinaryOnOff.Off) M1GuideConfig.M1GuideOff
    else M1GuideConfig.M1GuideOn(s)

  def decodeGuideSourceOption(s: String): Boolean = s.trim =!= "OFF"

  implicit val decodeComaOption: DecodeEpicsValue[String, ComaOption] =
    DecodeEpicsValue((s: String) => if (s.trim === "Off") ComaOption.ComaOff else ComaOption.ComaOn)

  def decodeM2Guide(s: BinaryOnOff, u: ComaOption, v: Set[TipTiltSource]): M2GuideConfig =
    if (s === BinaryOnOff.Off) M2GuideConfig.M2GuideOff
    else M2GuideConfig.M2GuideOn(u, v)

  implicit val decodeAoFold: DecodeEpicsValue[String, AoFold] = DecodeEpicsValue((s: String) =>
    if (s.trim === "IN") AoFold.In
    else AoFold.Out
  )

  implicit val decodeFollowOption: DecodeEpicsValue[String, FollowOption] =
    DecodeEpicsValue((s: String) => if (s.trim === "Off") FollowOff else FollowOn)

  implicit val decodeGuideSensorOption: DecodeEpicsValue[BinaryYesNo, GuiderSensorOption] =
    DecodeEpicsValue((s: BinaryYesNo) =>
      if (s === BinaryYesNo.No) GuiderSensorOff else GuiderSensorOn
    )

  implicit val decodeHwrsPickupPosition: DecodeEpicsValue[String, HrwfsPickupPosition] =
    DecodeEpicsValue((t: String) =>
      if (t.trim === "IN") HrwfsPickupPosition.IN
      else HrwfsPickupPosition.OUT
    )

}
